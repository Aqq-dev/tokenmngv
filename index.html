<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>TokenMgr Pro - Free</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body { background-color: #f3f4f6; color: #4b5563; font-family: sans-serif; font-size: 13px; }
        .sidebar-item { transition: 0.2s; border-radius: 6px; margin-bottom: 4px; padding: 10px; display: flex; align-items: center; gap: 12px; cursor: pointer; }
        .sidebar-active { background-color: #f1f5f9; color: #6366f1; font-weight: bold; }
        .status-spin { animation: spin 0.8s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <aside class="w-56 bg-white border-r flex flex-col shrink-0">
        <div class="p-5 flex items-center gap-2 mb-2">
            <img src="https://www.svgrepo.com/show/479510/tool.svg" class="w-6 h-6">
            <span class="font-bold text-lg text-slate-700">TokenMgr</span>
        </div>
        <nav class="flex-1 px-3 text-slate-500">
            <p class="text-[10px] text-gray-400 font-bold mb-4 px-3 tracking-wider uppercase">Admin Mode</p>
            <div class="sidebar-item sidebar-active"><i class="bi bi-list"></i> 一覧</div>
            <div onclick="toggleModal('inputModal', true)" class="sidebar-item hover:bg-gray-100"><i class="bi bi-plus-lg"></i> 追加</div>
            <div onclick="cleanupInvalid()" class="sidebar-item hover:bg-red-50 text-red-400"><i class="bi bi-stars"></i> 無効を掃除</div>
        </nav>
    </aside>

    <main class="flex-1 flex flex-col relative bg-[#f9fafb]">
        <header class="p-8 pb-4 flex justify-between items-center">
            <h2 class="text-2xl font-bold text-slate-800">トークン一覧</h2>
            <div class="flex gap-4 items-center">
                <div id="statusLabel" class="text-indigo-600 font-bold hidden"></div>
                <button onclick="checkAllTokens()" id="checkBtn" class="bg-indigo-600 text-white px-5 py-2 rounded shadow-md hover:bg-indigo-700 font-bold transition flex items-center gap-2">
                    <i class="bi bi-shield-check"></i> 確実チェック
                </button>
            </div>
        </header>

        <div class="flex-1 overflow-auto px-8 pb-32">
            <div class="bg-white rounded-lg border shadow-sm">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-50 text-gray-400 border-b text-[10px] uppercase font-bold">
                        <tr>
                            <th class="p-3 w-8 text-center"><i class="bi bi-list"></i></th>
                            <th class="p-3 w-8"><input type="checkbox" id="selectAll"></th>
                            <th class="p-3 w-10 text-center">Icon</th>
                            <th class="p-3 w-10 text-center">状態</th>
                            <th class="p-3">表示名 (編集可)</th>
                            <th class="p-3">Email</th>
                            <th class="p-3">トークン</th>
                            <th class="p-3 text-center">操作</th>
                        </tr>
                    </thead>
                    <tbody id="tokenTableBody" class="divide-y"></tbody>
                </table>
            </div>
        </div>

        <div class="absolute bottom-0 left-0 right-0 bg-white border-t p-4 flex justify-between items-center px-8 shadow-lg">
            <div class="text-sm font-bold text-slate-600"><span id="selectedCount">0</span> 件選択中</div>
            <div class="flex gap-2">
                <button onclick="copySelected()" class="px-4 py-2 bg-indigo-600 text-white rounded font-bold text-xs"><i class="bi bi-copy mr-1"></i> トークン一斉コピー</button>
                <button onclick="deleteSelected()" class="px-4 py-2 bg-red-500 text-white rounded font-bold text-xs"><i class="bi bi-trash mr-1"></i> 一括削除</button>
            </div>
        </div>
    </main>

    <div id="inputModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-[500px] p-6">
            <h3 class="text-lg font-bold mb-4">トークン一括追加</h3>
            <textarea id="bulkInput" class="w-full h-48 p-4 border rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 font-mono text-xs" placeholder="トークンを貼り付け"></textarea>
            <div class="mt-4 flex justify-end gap-2">
                <button onclick="toggleModal('inputModal', false)" class="px-4 py-2 text-gray-400">閉じる</button>
                <button onclick="processBulkInput()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-bold">追加</button>
            </div>
        </div>
    </div>

    <script>
        let tokens = JSON.parse(localStorage.getItem('token_mgr_v5') || '[]');
        const ERROR_ICON = "https://i.postimg.cc/CxyfBNQ1/35112-error11.png";

        function save() {
            localStorage.setItem('token_mgr_v5', JSON.stringify(tokens));
            render();
        }

        function toggleModal(id, show) {
            document.getElementById(id).style.display = show ? 'flex' : 'none';
        }

        function maskEmail(email) {
            if (!email || !email.includes('@')) return email;
            const p = email.split('@');
            const pos = Math.max(0, Math.floor(Math.random() * (p[0].length - 2)));
            return p[0].substring(0, pos) + "**" + p[0].substring(pos + 2) + "@" + p[1];
        }

        async function processBulkInput() {
            const val = document.getElementById('bulkInput').value;
            const found = [...new Set(val.match(/[A-Za-z0-9\._-]{24,}/g) || [])];
            found.forEach(t => {
                if (!tokens.find(ex => ex.val === t)) {
                    tokens.push({ id: Date.now() + Math.random(), val: t, name: "未取得", email: "...", icon: null, status: "unknown" });
                }
            });
            toggleModal('inputModal', false);
            save();
        }

        async function fetchInfo(t) {
            try {
                const r = await fetch('https://discord.com/api/v9/users/@me', { 
                    headers: { 'Authorization': t.val }
                });
                
                if (r.status === 200) {
                    const d = await r.json();
                    t.name = d.global_name || d.username;
                    t.email = maskEmail(d.email || d.phone || "No Info");
                    t.icon = d.avatar ? `https://cdn.discordapp.com/avatars/${d.id}/${d.avatar}.png?size=32` : `https://cdn.discordapp.com/embed/avatars/0.png`;
                    t.status = d.verified ? "active" : "locked";
                } else if (r.status === 401 || r.status === 403) {
                    t.status = "invalid";
                    t.name = "無効なトークン";
                } else if (r.status === 429) {
                    t.status = "unknown";
                    t.name = "レート制限中";
                } else {
                    t.status = "invalid";
                }
            } catch (e) {
                t.status = "invalid";
                t.name = "通信エラー (要拡張機能)";
            }
        }

        async function changeDisplayName(id) {
            const t = tokens.find(x => x.id === id);
            const newName = prompt("新しい表示名を入力してください", t.name);
            if (!newName) return;

            try {
                const r = await fetch('https://discord.com/api/v9/users/@me', {
                    method: 'PATCH',
                    headers: { 'Authorization': t.val, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ global_name: newName })
                });
                if (r.ok) {
                    alert("変更完了");
                    t.name = newName;
                    save();
                } else {
                    const err = await r.json();
                    alert("失敗: " + (err.message || "権限がありません"));
                }
            } catch { alert("通信に失敗しました"); }
        }

        async function checkAllTokens() {
            const btn = document.getElementById('checkBtn');
            const label = document.getElementById('statusLabel');
            btn.disabled = true;
            label.classList.remove('hidden');

            for (let i = 0; i < tokens.length; i++) {
                const t = tokens[i];
                label.innerText = `Checking (${i+1}/${tokens.length})...`;
                t.status = "checking";
                render();
                
                await fetchInfo(t);

                await new Promise(res => setTimeout(res, 300));
                save();
            }

            btn.disabled = false;
            label.classList.add('hidden');
        }

        function render() {
            const tbody = document.getElementById('tokenTableBody');
            tbody.innerHTML = tokens.map(t => {
                const displayIcon = (t.status === 'invalid') ? ERROR_ICON : (t.icon || "https://cdn.discordapp.com/embed/avatars/0.png");
                
                return `
                <tr class="hover:bg-gray-50 transition ${t.status === 'invalid' ? 'bg-red-50' : ''}">
                    <td class="p-3 text-gray-300 text-center"><i class="bi bi-list"></i></td>
                    <td class="p-3"><input type="checkbox" class="token-check" data-id="${t.id}"></td>
                    <td class="p-3 text-center">
                        <div class="w-7 h-7 rounded-full bg-gray-200 overflow-hidden mx-auto border flex items-center justify-center">
                            <img src="${displayIcon}" class="w-full h-full object-cover">
                        </div>
                    </td>
                    <td class="p-3 text-center">
                        ${t.status === 'active' ? '<i class="bi bi-check-circle-fill text-green-500"></i>' : 
                          t.status === 'locked' ? '<i class="bi bi-exclamation-circle-fill text-yellow-500"></i>' :
                          t.status === 'invalid' ? '<i class="bi bi-x-circle-fill text-red-500"></i>' : 
                          t.status === 'checking' ? '<i class="bi bi-arrow-repeat status-spin text-indigo-400"></i>' : '<i class="bi bi-dash"></i>'}
                    </td>
                    <td class="p-3">
                        <div class="flex items-center gap-2 group">
                            <span class="font-bold text-slate-700">${t.name}</span>
                            <i onclick="changeDisplayName(${t.id})" class="bi bi-pencil-square text-indigo-400 cursor-pointer opacity-0 group-hover:opacity-100 transition"></i>
                        </div>
                    </td>
                    <td class="p-3 text-gray-400 text-xs">${t.email}</td>
                    <td class="p-3 font-mono text-indigo-400 text-[10px]">
                        ${t.val.substring(0,10)}...
                        <button onclick="navigator.clipboard.writeText('${t.val}')" class="ml-1 hover:text-indigo-600"><i class="bi bi-copy"></i></button>
                    </td>
                    <td class="p-3 text-center">
                        <button onclick="deleteToken(${t.id})" class="text-white bg-red-400 p-1 rounded hover:bg-red-500"><i class="bi bi-trash"></i></button>
                    </td>
                </tr>`;
            }).join('');
            document.getElementById('selectedCount').innerText = document.querySelectorAll('.token-check:checked').length;
        }

        function cleanupInvalid() { tokens = tokens.filter(t => t.status !== 'invalid'); save(); }
        function deleteToken(id) { tokens = tokens.filter(t => t.id !== id); save(); }
        function copySelected() {
            const checked = Array.from(document.querySelectorAll('.token-check:checked')).map(cb => tokens.find(t => t.id == cb.dataset.id).val);
            if(checked.length) navigator.clipboard.writeText(checked.join('\n'));
        }
        function deleteSelected() {
            const ids = Array.from(document.querySelectorAll('.token-check:checked')).map(cb => Number(cb.dataset.id));
            if(ids.length && confirm("削除しますか？")) { tokens = tokens.filter(t => !ids.includes(t.id)); save(); }
        }
        document.addEventListener('change', (e) => {
            if (e.target.id === 'selectAll') document.querySelectorAll('.token-check').forEach(cb => cb.checked = e.target.checked);
            document.getElementById('selectedCount').innerText = document.querySelectorAll('.token-check:checked').length;
        });

        render();
    </script>
</body>
</html>
